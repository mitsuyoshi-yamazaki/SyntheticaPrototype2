# エネルギー消費仕様

## このファイルについて

本ファイルはSyntheticaPrototype2におけるエネルギー消費に関する仕様をまとめたものです。ユニット種別ごとの操作および、その他の操作によるエネルギー消費の一覧を記載します。

## エネルギー消費の分類

### 1. ユニット生成・分解

#### HULL
- **生成時**
  - 構成エネルギー = `容量 × 2E`
  - 生産エネルギー = `ceil(構成エネルギー × 0.05)`
  - **合計コスト** = 構成エネルギー + 生産エネルギー
  - **例**: 容量100のHULL
    - 構成エネルギー = 100 × 2 = 200E
    - 生産エネルギー = ceil(200 × 0.05) = 10E
    - 合計 = 210E

- **マージ時**
  - エネルギー消費量：仕様書に明記されていないが消費する（TBD）

#### ASSEMBLER
- **生成時**
  - 構成エネルギー = `8000E + (assemble_power × 2000E)` （assemble_powerは1以上）
  - 生産エネルギー = `ceil(構成エネルギー × 0.5)`
  - **例**: assemble_power=5のASSEMBLER
    - 構成エネルギー = 8000 + (5 × 2000) = 18000E
    - 生産エネルギー = ceil(18000 × 0.5) = 9000E
    - 合計 = 27000E

#### DISASSEMBLER
- **生成時**
  - 構成エネルギー = `2000E + (disassemble_power × 200E)`
  - 生産エネルギー = `ceil(構成エネルギー × 0.2)`
  - **例**: disassemble_power=10のDISASSEMBLER
    - 構成エネルギー = 2000 + (10 × 200) = 4000E
    - 生産エネルギー = ceil(4000 × 0.2) = 800E
    - 合計 = 4800E

#### COMPUTER
- **生成時**
  - 構成エネルギー = `5000E + ceil((動作周波数 / 5)^2 × 1000E) + (メモリ容量 × 500E)`
  - 生産エネルギー = `ceil(構成エネルギー × 0.2)`
  - **例1**: 動作周波数10/tick、メモリ256バイトのCOMPUTER
    - 構成エネルギー = 5000 + ceil((10/5)^2 × 1000) + (256 × 500)
    - = 5000 + ceil(4 × 1000) + 128000
    - = 5000 + 4000 + 128000 = 137000E
    - 生産エネルギー = ceil(137000 × 0.2) = 27400E
    - 合計 = 164400E
  - **例2**: 動作周波数1/3tick、メモリ64バイトのCOMPUTER
    - 構成エネルギー = 5000 + ceil((0.333/5)^2 × 1000) + (64 × 500)
    - = 5000 + ceil(0.0044 × 1000) + 32000
    - = 5000 + 5 + 32000 = 37005E
    - 生産エネルギー = ceil(37005 × 0.2) = 7401E
    - 合計 = 44406E

### 2. ユニット操作によるエネルギー消費

#### ASSEMBLER操作
- **ユニット生産処理**
  - 生産中ユニット生成 = `ceil(完成ユニットの構成エネルギー × 0.1)`
  - 生産継続（tickごと）= assemble_powerに比例（詳細な計算式は未定義）
  - **例**: 容量100のHULL生産
    - 生産中ユニット生成 = ceil(200 × 0.1) = 20E
    - 生産継続 = assemble_power量のエネルギーを毎tick消費

- **ユニット修復**
  - 修復エネルギー = `n + (n × ユニット生産エネルギー / ユニット構成エネルギー) × 1.1`
  - **例**: 50Eのダメージを受けたHULLの修復
    - n = 50
    - 修復エネルギー = 50 + (50 × 10 / 200) × 1.1 = 50 + 2.75 = 52.75E → 53E

#### DISASSEMBLER操作
- **分解試行**
  - 最低1E以上を投入（投入量は任意）
  - 成功・失敗に関わらず投入エネルギーは全量消費
  - 成功時：対象から剥ぎ取られたエネルギーが周囲に出現
  - 失敗時：投入エネルギーは熱に変換

#### COMPUTER操作
- **命令実行**（Synthetica Script）
  - 1バイト命令: 0.1E
  - 3バイト命令: 0.3E
    - レジスタベース命令: 0.35E
    - 間接アドレス命令: 0.4E
  - 4バイト命令: 0.4E
    - 絶対アドレス命令: 0.6E
    - レジスタベースユニット操作: 0.45E + 1E（ユニット操作）
  - 5バイト命令: 0.5E
    - 即値ロード: 0.5E
  - テンプレートマッチング:
    - 基本コスト: 0.3E
    - テンプレート長: length × 0.05E
    - 検索距離: distance × 0.01E
    - 失敗時: 基本コスト + 最大検索距離 × 0.01E
  - ユニット操作命令: +1E 追加

- **動作周波数による基本消費**
  - tickあたり: `動作周波数 × 命令実行エネルギー`
  - **例**: 10命令/tickのCOMPUTERが1バイト命令を実行
    - tickあたり消費 = 10 × 0.1E = 1E/tick

### 3. 環境によるエネルギー消費

#### 熱ダメージ
- セルの熱が100度を超えた場合
- ダメージ量 = `ceil((熱 - 100) × 0.1)E` per tick
- ユニット状態による倍率:
  - 通常状態: ×1
  - 部分損傷状態（構成エネルギーの50%以下）: ×2
  - 生産中ユニット: ×3
- **例**: 熱150度のセルにいる通常ユニット
  - ダメージ = ceil((150 - 100) × 0.1) = ceil(5) = 5E/tick
- **例**: 熱120度のセルにいる生産中ユニット
  - ダメージ = ceil((120 - 100) × 0.1) × 3 = ceil(2) × 3 = 6E/tick

### 4. 物理的相互作用によるエネルギー消費

#### 移動・加速
- ユニットの移動にかかるエネルギー消費の詳細は未定義（TBD）

#### 衝突・反発
- 反発力計算の詳細は未定義（TBD）

### 5. エネルギーの熱変換

全てのエネルギー消費は、消費された場所のセルに熱として加算される:
- 消費エネルギー量 = 発生熱量
- 熱の拡散・放熱は環境処理フェーズで処理

## エネルギー効率の例

### 自己複製エージェントのエネルギー収支

#### 最小構成エージェント（容量100のHULL内にASSEMBLER、COMPUTER）
1. **初期生成コスト**
   - HULL(100): 210E
   - ASSEMBLER(power=1): 8000 + 1000 + ceil(9000 × 0.5) = 13500E
   - COMPUTER(1Hz, 256B): 5000 + 5 + 128000 + ceil(133005 × 0.2) = 159606E
   - **合計**: 173316E

2. **運用時消費**（tickあたり）
   - COMPUTER動作: 0.1E～0.6E（命令による）
   - 熱ダメージ: 環境温度による

3. **自己複製コスト**
   - 娘個体生成: 初期生成コストと同等 = 173316E
   - 追加で必要な作業エネルギー: 数百E（メモリコピー等）

### エネルギー源からの収支バランス
- エネルギーソースの産出量: ソースごとに設定（未定義）
- 効率的なエネルギー回収と消費のバランスが生存の鍵

## 未定義項目（TBD）

1. **HULLマージのエネルギーコスト**
2. **ユニット移動のエネルギーコスト**
3. **ASSEMBLERの生産継続時の詳細なエネルギー消費式**
4. **エネルギーソースごとの産出量**
5. **物理的相互作用（衝突等）のエネルギーコスト**

## 備考

- エネルギー消費の失敗（不足）時は、アクション種別ごとに定義された失敗処理が実行される
- エネルギー確保フェーズとアクション実行フェーズは分離されている
- 全てのエネルギー消費は熱として環境に影響を与える

## エネルギー表現の課題と解決案

### 課題

#### 課題1: 16bit制限（最大65,535）
- COMPUTERは16bitアーキテクチャのため、計算で扱うエネルギー量を65,535以内に収めたい
- 現在のエネルギー量の例：
  - COMPUTER生成: 164,400E（16bit範囲を超過）
  - 最小構成エージェント: 173,316E（同様に超過）

#### 課題2: 小数回避とCOMPUTER実行コストの精度
- エネルギー消費量は実装の簡便さのため整数にしたい
- COMPUTER実行コスト（0.1E～0.6E）はceil/floorを避けたい
  - 丸め処理を行うと実行周波数によるエネルギーコストの差が出にくくなる
- 全体を10倍にすれば解決するが、課題1と矛盾する

### 解決案の検討

#### 案1: エネルギー単位の階層化
- **基本単位（mE）**: ミリエネルギー（1/1000E）
- **標準単位（E）**: 現在のエネルギー
- **大単位（kE）**: キロエネルギー（1000E）

```
COMPUTER命令実行: 100mE～600mE（整数）
HULL(100)生成: 210E = 210,000mE
COMPUTER生成: 164kE + 400E
```

**利点**: 
- 小数を回避しつつ精度維持
- 用途に応じた単位選択が可能

**欠点**: 
- 単位変換の実装が必要
- プレイヤーの理解が複雑に

#### 案2: 分割計算方式（上位/下位バイト）
```
エネルギー = 上位16bit（kE単位） + 下位16bit（E単位）
例: 164,400E = 164kE + 400E = [0x00A4][0x0190]
```

**利点**: 
- 32bit相当の範囲を16bitレジスタで扱える
- 大雑把な計算は上位のみで可能

**欠点**: 
- 計算ロジックが複雑
- キャリー処理が必要

#### 案3: スケール調整と固定小数点
- 全エネルギー値を100倍（2桁固定小数点）
- COMPUTER実行: 10～60（0.1E～0.6Eを表現）
- 最大値を調整（生成コストを削減）

**利点**: 
- 実装がシンプル
- 小数を整数で表現

**欠点**: 
- 大きな値の表現範囲が狭い

#### 案4: エネルギーコストの全体的な見直し
現在のコスト体系を根本的に見直し：
- COMPUTER生成コストを大幅削減（メモリコストを1/10に）
- 基本単位を10倍（最小単位1→10）

**利点**: 
- 16bit範囲に収まる
- バランス調整の機会

**欠点**: 
- 全体のバランス再設計が必要

#### 案5: ハイブリッドアプローチ
- **精密計算用**: E単位（1E = 10内部単位）
  - COMPUTER実行: 1～6内部単位
  - 小規模操作用
- **大規模計算用**: 100E単位での概算
  - ユニット生成コスト
  - 16bit範囲で表現

**利点**: 
- 用途に応じた精度
- 実装の柔軟性

**欠点**: 
- 2つの計算体系の管理

#### 案6: 対数スケール
エネルギー値を対数で管理：
```
実際の値 = 2^(格納値/1000)
```

**利点**: 
- 広範囲を16bitで表現
- 自然な指数的成長

**欠点**: 
- 計算が複雑
- 直感的でない

#### 案7: エネルギーと構造材の分離（新提案）

現在の仕様で「エネルギー消費」として表現されている資源消費は、本来は以下の2種類：
- **a. ユニット機能を動かすためのエネルギー消費**（動力）
- **b. ユニットを構築する構造材としての資源の消費**（材料）

これらを分離し、2種類の資源として扱う：

**現在の例**:
- ユニット生成時の「構成エネルギー」→ 構造材消費
- ユニット生成時の「生産エネルギー」→ エネルギー消費
- COMPUTER実行コスト → エネルギー消費のみ

**分離後の例**:
```
HULL(容量100)生成:
- 構造材: 200M（Material）
- エネルギー: 10E

COMPUTER(10Hz, 256B)生成:
- 構造材: 130,000M
- エネルギー: 7,000E

COMPUTER命令実行:
- エネルギー: 1～6（0.1E～0.6E × 10）
- 構造材: 0（消費なし）
```

**利点**:
- 各資源が16bit範囲に収まる
- 概念的に明確（動力 vs 材料）
- ゲームプレイの戦略性向上

**欠点と課題**:

**1. 新資源の物理的性質**
- 構造材の形態（ゲームオブジェクトか？）
- 保管・輸送方法（重量、体積）
- 分解時の挙動

**2. 既存システムへの影響**
- エネルギーソースとは別の構造材供給源が必要
- 熱システムへの影響（構造材消費は熱を発生させるか）
- DISASSEMBLERの動作変更

**3. ユニット操作への影響**
- ASSEMBLERのメモリマップ拡張
- 生産条件の複雑化（両資源が必要）
- HULLの2種類資源の格納管理

**4. バランス設計**
- 各ユニットの構造材/エネルギー比率
- 初期配置と供給バランス
- 片方の資源枯渇時の対処

**5. 実装の複雑性**
- Synthetica Scriptの拡張
- UI表現の複雑化

**6. 自己複製への影響**
- 2種類の資源収集が必要
- 資源循環の効率

### 推奨案

**案2（分割計算方式）** と **案4（コスト見直し）** の組み合わせを推奨：

1. エネルギーを上位/下位16bitで管理
2. 同時にコスト体系を調整：
   - メモリコスト: 500E/B → 50E/B
   - 基本エネルギー単位を10倍
   - COMPUTER実行: 1～6（0.1E～0.6E × 10）

これにより：
- 16bit×2で広範囲をカバー
- 小数を回避
- 実装は若干複雑だが、ゲーム性を維持

**ただし、案7（エネルギーと構造材の分離）は根本的な解決策として有力であり、ゲーム設計の初期段階での採用を検討する価値がある。**