# v3仕様分析レポート

## このファイルについて

- 本ファイルは `game-world-requirement.md` の仕様分析結果をまとめたものです
- 仕様の矛盾、不足、実装上の課題を特定し、解決に向けた作業を整理します

## 分析実施日

- 2025-07-12

## 1. 仕様の不足・未定義項目（TBD）

### 1.1 処理順序の未定義 ✅ **解決済み**
- **場所**: `game-world-requirement.md:67`
- **内容**: tickの処理順が未定義
- **解決方法**: 5フェーズからなる詳細な処理順序を策定
  - アクション予約制による競合回避
  - 物理演算、環境処理、熱処理の分離
  - アクション競合時の明確な解決ルール
- **状態**: 解決済み（2025-07-12）

### 1.2 ユニット生成仕様の未定義 ✅ **解決済み**

#### HULL生成仕様 ✅ **解決済み**
- **場所**: `game-world-requirement.md:192-193`
- **解決方法**: 
  - 構成エネルギー = `容量 × 2E`
  - 生産エネルギー = `ceil(構成エネルギー × 0.05)`
- **改善**: 容量とコストの乖離を解消（容量100のHULLが200Eで生成可能）
- **状態**: 解決済み（2025-07-12）

#### ASSEMBLER生成仕様 ✅ **解決済み**
- **場所**: `game-world-requirement.md:228-230`
- **解決方法**: 
  - 構成エネルギー = `8000E + (assemble_power × 2000E)` (power≥1)
  - 生産エネルギー = `ceil(構成エネルギー × 0.5)`
- **変更**: 生産エネルギー比率を0.2→0.5に調整
- **状態**: 解決済み（2025-07-12）

#### DISASSEMBLER生成仕様 ✅ **解決済み**
- **場所**: `game-world-requirement.md:253-254`
- **解決方法**: 
  - 構成エネルギー = `2000E + (disassemble_power × 200E)`
  - 生産エネルギー = `ceil(構成エネルギー × 0.2)`
- **変更**: 基本コストを3000E→2000Eに削減
- **状態**: 解決済み（2025-07-12）

#### COMPUTER生成仕様 ✅ **解決済み**
- **場所**: `game-world-requirement.md:279-280`
- **解決方法**: 
  - 構成エネルギー = `5000E + ceil((動作周波数/5)² × 1000E) + (メモリ容量 × 500E)`
  - 生産エネルギー = `ceil(構成エネルギー × 0.2)`
- **重要な改善**: 
  - 動作周波数が二乗コストで効率的上限25/tick設定
  - 分数周波数(1/n tick)対応
  - メモリ容量0指定可能
- **状態**: 解決済み（2025-07-12）

## 2. 仕様の矛盾・不明確な部分

### 2.1 HULLマージ仕様の不明確性 ✅ **解決済み**
- **場所**: `game-world-requirement.md:196-203`
- **解決方法**: 
  - ユニット結合構造をHULL中心の管理方式で明確化
  - マージ実行順序を「物質出入り解決→マージ実行」と定義
  - マージ後の統合ルールを詳細化：
    - 固定ユニット・格納オブジェクトの移行
    - 回路接続の統合
    - 容量の合計
- **追加定義**: ユニット状態（固定/格納/自由）と隣接・ダメージルールを明確化
- **状態**: 解決済み（2025-07-12）

### 2.2 HULL分離機構の未定義 ✅ **解決済み**
- **場所**: `game-world-requirement.md:204-208`
- **解決方法**: 
  - HULLは他のHULLに固定可能
  - HULL以外のユニットは破壊以外で固定解除不可
  - HULLのみが自身の固定を任意で解除可能（分離機構）
  - 自己複製時の娘個体分離に利用
- **状態**: 解決済み（2025-07-12）

### 2.3 エネルギー消費タイミングの不整合 ✅ **解決済み**
- **場所**: `game-world-requirement.md:69-73, 105-108`
- **問題**: 各ユニットでエネルギー消費タイミング（事前/実行時）が異なっていた
- **解決方法**: エネルギー消費の統一フレームワークを導入
  - エネルギー確保フェーズとアクション実行フェーズを分離
  - エネルギー確保失敗とアクション処理失敗を別処理として明確化
  - エネルギー確保失敗時の挙動をアクション種別ごとに定義
- **TODO**: エネルギー確保順序とアクション実行順序の決定（全アクション洗い出し後）
- **状態**: 解決済み（2025-07-12）

## 3. 自己複製エージェント実現可能性の課題

### 3.1 受動自律エージェントの実装課題 🔄 **部分解決**

#### ライフサイクル実現性
- **ステップ3**: HULL拡張のための小容量HULL生成 ✅ **解決済み**
  - **解決済み**: HULLマージ仕様が明確化済み（2.1で解決）
  - **解決済み**: エネルギーコスト計算式が確定済み（1.2で解決）
  
- **ステップ4**: 娘個体生成 ✅ **解決済み**
  - **解決済み**: HULL分離機構が定義済み（2.2で解決）
  - **解決済み**: 分離条件と仕組みが明確化済み

#### ソフトウェア実装の詳細化必要項目 🔄 **残存課題**
- HULLの容量監視・判定機構（実装時に詳細化）
- マージ対象HULL生成の位置制御（実装時に詳細化）
- 娘個体への初期プログラム転送機構（Synthetica Script仕様に依存）

**実現可能性**: 基本的な仕組みは全て定義済み。残る課題は実装詳細のみ。

### 3.2 非生命複製子の不明確性 ✅ **解決済み**
- **場所**: `game-world-requirement.md:254-257`
- **問題**: 「動作状態の自己複製単一目的ASSEMBLER」の仕様が抽象的
- **解決方法**: 前バージョンからの引き継ぎ項目で今バージョンでは実装対象外のため削除
- **状態**: 解決済み（2025-07-12）

## 4. 実装優先度の課題

### 4.1 CONNECTORユニットの必要性再検討
- **場所**: `game-world-requirement.md:285-286`
- **現状**: 次バージョン扱い
- **問題**: 現仕様で実際に「自身の管理下にないユニットとの接続」が必要なケースが不明
- **要検討**: 
  - 隣接状態での操作で十分でないか？
  - 捕食者実装に本当に必要か？

### 4.2 ゲーム要件との整合性
- **要件**: オープンエンドな進化の実現
- **課題**: 現仕様で十分な創発性が得られるかの検証が必要
- **検討項目**:
  - エネルギー効率競争による進化圧
  - 異なる戦略（速度 vs 効率 vs 堅牢性）の実現可能性

## 5. 今後の作業計画

### Phase 1: 基本仕様の確定（高優先度） ✅ **完了**
1. ~~tickの処理順序決定~~ ✅
2. ~~各ユニットの生成仕様（エネルギーコスト）決定~~ ✅
3. ~~HULL分離機構の仕様策定~~ ✅

### Phase 2: 自己複製機構の詳細化（高優先度） ✅ **完了**
1. ~~HULLマージ時の結合状況変化の仕様化~~ ✅
2. ~~受動自律エージェントの実装手順詳細化~~ ✅
3. プログラム転送機構の仕様策定（Synthetica Script仕様に依存）

### Phase 3: 一貫性確保・最適化（中優先度） ✅ **完了**
1. ~~エネルギー消費タイミングの統一~~ ✅
2. ~~非生命複製子仕様の詳細化~~ ✅（削除対応）
3. CONNECTORユニット必要性の再評価（残存）

### Phase 4: 実装可能性検証（中優先度）
1. 自己複製エージェントの実装試行
2. ゲーム要件（オープンエンド進化）達成可能性の検証
3. パフォーマンス・バランス調整

## 6. 確認が必要な点

### 6.1 設計思想の確認
- エネルギー効率による自然選択圧で十分な進化が期待できるか？
- プレイヤーの創造性を引き出すのに十分な自由度があるか？

### 6.2 技術的制約の確認 ✅ **対象外**
- 連続座標系でのリアルタイムシミュレーション性能
- p5.jsでの描画性能（多数のエージェント存在時）
- **状態**: プロトタイピング段階では検討対象外（2025-07-12）

### 6.3 ゲームバランスの確認
- 自己複製に必要なエネルギー量の適切性
- エネルギーソースの配置・産出量バランス

## 7. 仕様策定の進捗状況

### ✅ **完了した重要課題**
1. ~~**HULL分離機構の仕様策定**~~ ✅ 自己複製実現の基盤完成
2. ~~**ユニット生成エネルギーコストの数値設定**~~ ✅ バランス調整基盤完成
3. ~~**tick処理順序の決定**~~ ✅ 動作の一貫性確保
4. ~~**HULLマージ仕様の明確化**~~ ✅ エージェント拡張機構完成
5. ~~**エネルギー消費タイミング統一**~~ ✅ 予測可能な動作保証

### 🔄 **残存課題**
- エネルギー確保順序とアクション実行順序の決定（全アクション洗い出し後）
- CONNECTORユニット必要性の再評価
- Synthetica Script仕様（プログラム転送機構に影響）
- **COMPUTER生成時のメモリ書き込み機構の仕様策定**（新規TODO）

## 8. 新規TODO項目

### 8.1 COMPUTER生成時のメモリ書き込み機構 📋 **TODO**

#### 課題
COMPUTERを生成した際に、そのメモリ内容をどのように書き込むかの仕様が未定義

#### 検討中の案

##### 案A: 生成時メモリ内容直接入力
- **概要**: ASSEMBLER生成時にメモリ内容も引数として与える
- **利点**: シンプルで直感的
- **欠点**: 
  - ASSEMBLERに生成COMPUTER同等の巨大メモリ容量が必要
  - メモリ書き込み量に応じた処理クロックが必要

##### 案B: 外部書き換え許可プロパティ方式
- **概要**: 
  - COMPUTERに「外部からのメモリ書き換え許可/拒否」プロパティを追加
  - 生成時は「許可」状態で生成
  - 生成後に親COMPUTERがメモリ書き込み
  - 処理を子COMPUTERへ引き継ぎ（詳細はSynthetica Script仕様に依存）
- **利点**: 
  - ASSEMBLERへの負荷が軽減
  - 段階的なメモリ書き込みが可能
- **欠点**: 
  - 実装が複雑
  - セキュリティリスク（外部書き換え許可状態）

#### 追加検討案

##### 案C: プログラムローダーユニット方式
- **概要**: 
  - 専用の「PROGRAM_LOADER」ユニットを新設
  - COMPUTERとPROGRAM_LOADERを接続してメモリ転送
  - 転送完了後にPROGRAM_LOADERを分解
- **利点**: 
  - 役割分離でセキュリティ向上
  - 他COMPUTERへの影響なし
- **欠点**: 
  - 新ユニット追加によるコスト増加
  - メモリ内容を（親COMPUTERからコピーするのではなく）生成するのであれば新たなユニットを追加する意味がない

##### 案D: 段階的初期化方式
- **概要**: 
  - COMPUTERを「初期化中」状態で生成
  - 初期化中は低速動作でメモリ書き込み専用命令のみ実行可能
  - 初期化完了後に通常動作へ移行
- **利点**: 
  - 既存ユニットの拡張のみで実現
  - 自然なライフサイクル
- **欠点**: 
  - 初期化中の動作制限が複雑
- **備考**: 壊れる隙のない複製方式は揺らぎによる突然変異を防いでしまう

#### 各案の課題・改善点

##### 案Aの改善策
- ASSEMBLERにメモリ容量制限を設け、大容量COMPUTERは分割書き込みを必要とする
- メモリ書き込み専用の高速モードを追加

##### 案Bの改善策
- 外部書き換え許可状態に時間制限を設ける
- 書き換え許可対象を特定COMPUTERのみに制限

##### 共通の不備
- メモリ書き込み中のエラーハンドリングが未定義
- 書き込み失敗時の復旧手順が不明
- 同時複数COMPUTER生成時の競合処理が未考慮

#### 推奨方針
**案D（段階的初期化）+ 案Bの要素**を組み合わせた方式を推奨：
- 生成時は「初期化中」状態
- 初期化中は親COMPUTERからの書き込み専用命令のみ受付
- 初期化完了で通常動作に移行し、外部書き換え拒否状態に自動変更

### 🎯 **達成状況**
**実装可能な仕様への到達**: ✅ **達成済み**
基本的な自己複製エージェントの実装に必要な全ての仕組みが定義完了。