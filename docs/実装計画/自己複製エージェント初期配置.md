# 自己複製エージェント初期配置 実装計画

## 概要

アプリケーション起動時に、サンプルの自己複製エージェントが配置された状態で開始できるようにする機能を実装する。

## 背景

現在のシステムでは、起動時にエネルギーソースと力場のみが配置され、エージェントは存在しない。
自己複製の動作を確認し、デモンストレーションを行うために、初期状態で自己複製可能なエージェントを配置する必要がある。

## 実装計画

### 1. 自己複製プログラムの作成

#### 1.1 プログラム仕様

**必要なユニット構成：**
- HULL：エネルギー格納、他ユニットの接続基盤
- ASSEMBLER：新しいユニットを生産
- COMPUTER：自己複製プログラムを実行

**プログラムの動作フロー：**
1. エネルギー収集の開始（ENERGY命令）
2. 十分なエネルギーが蓄積されるまで待機
3. SCANM命令で自身のプログラムを一時領域にコピー
4. ASSEMBLE命令でASSEMBLERに新しいCOMPUTERの生産を指示
5. 生産完了を待機
6. 新しいCOMPUTERに自身のプログラムをコピー
7. 新しいユニットをHULLから分離
8. プロセスを繰り返す

#### 1.2 実装ファイル
- `src/engine/presets/programs/self-replicator-program.ts`
  - アセンブリコードの定義
  - バイトコードへの変換関数
  - プログラムサイズの定数

### 2. エージェントプリセットシステム

#### 2.1 型定義

```typescript
// src/engine/presets/types.ts
export interface AgentPreset {
  readonly name: string
  readonly description: string
  readonly units: ReadonlyArray<UnitDefinition>
  readonly program?: Uint8Array // COMPUTERユニット用プログラム
}

export interface UnitDefinition {
  readonly type: "HULL" | "ASSEMBLER" | "COMPUTER"
  readonly relativePosition: Vec2 // HULLからの相対位置
  readonly parameters: UnitSpec
  readonly isAttached: boolean // HULLに固定するか
}
```

#### 2.2 自己複製エージェントプリセット

```typescript
// src/engine/presets/self-replicator-preset.ts
export const SELF_REPLICATOR_PRESET: AgentPreset = {
  name: "BasicSelfReplicator",
  description: "基本的な自己複製エージェント",
  units: [
    {
      type: "HULL",
      relativePosition: { x: 0, y: 0 },
      parameters: {
        type: "HULL",
        capacity: 1000,
      },
      isAttached: false,
    },
    {
      type: "ASSEMBLER",
      relativePosition: { x: 15, y: 0 },
      parameters: {
        type: "ASSEMBLER",
        assemblePower: 10,
      },
      isAttached: true,
    },
    {
      type: "COMPUTER",
      relativePosition: { x: -15, y: 0 },
      parameters: {
        type: "COMPUTER",
        processingPower: 5,
        memorySize: 512,
      },
      isAttached: true,
    },
  ],
  program: generateSelfReplicatorProgram(),
}
```

### 3. エージェント生成機能の拡張

#### 3.1 AgentFactory

```typescript
// src/engine/agent-factory.ts
export class AgentFactory {
  public static createFromPreset(
    preset: AgentPreset,
    position: Vec2,
    world: World
  ): Hull {
    // 1. HULLを生成
    // 2. 他のユニットを生成して配置
    // 3. attachedフラグに基づいて接続
    // 4. COMPUTERにプログラムをロード
    // 5. プログラムを開始
  }
}
```

#### 3.2 既存システムとの統合

- `ObjectFactory`を使用してユニットを生成
- `ComputerVMSystem`を使用してプログラムをロード
- `CircuitConnectionSystem`を使用してユニット間を接続

### 4. Worldクラスの拡張

#### 4.1 設定の拡張

```typescript
export interface WorldConfig {
  // 既存のフィールド...
  
  // 新規追加
  readonly enableDefaultAgents?: boolean
  readonly defaultAgentPresets?: ReadonlyArray<{
    preset: AgentPreset
    position: Vec2
  }>
}
```

#### 4.2 初期化処理の修正

```typescript
private initialize(config: WorldConfig): void {
  // エネルギーソースの配置
  this.placeEnergySources()
  
  // デフォルトエージェントの配置（新規追加）
  if (config.enableDefaultAgents !== false) {
    this.placeDefaultAgents(config.defaultAgentPresets)
  }
  
  // カスタム初期エージェントの配置
  if (config.initialAgents != null) {
    for (const agentDef of config.initialAgents) {
      this.addAgent(agentDef)
    }
  }
}
```

### 5. GameWorldクラスの修正

```typescript
// src/lib/GameWorld.ts
export class GameWorld {
  public constructor(width: number, height: number) {
    this._world = new World({
      width,
      height,
      parameters: {
        energySourceCount: 5,
        energySourceMinRate: 50,
        energySourceMaxRate: 150,
        ticksPerFrame: 1,
      },
      enableDefaultAgents: true, // デフォルトで有効
      defaultAgentPresets: [
        {
          preset: SELF_REPLICATOR_PRESET,
          position: { x: width * 0.3, y: height * 0.5 },
        },
      ],
      initialAgents: [],
    })
    
    // 力場の追加...
  }
}
```

### 6. 実装順序とタスク

1. **プログラム作成**
   - [ ] 自己複製プログラムのアセンブリコード設計
   - [ ] バイトコード変換関数の実装
   - [ ] プログラムの単体テスト

2. **プリセットシステム**
   - [ ] 型定義ファイルの作成
   - [ ] 自己複製エージェントプリセットの実装
   - [ ] プリセット検証関数の実装

3. **エージェント生成**
   - [ ] AgentFactoryクラスの実装
   - [ ] プリセットからの生成機能
   - [ ] ユニット接続処理

4. **World統合**
   - [ ] WorldConfig型の拡張
   - [ ] デフォルトエージェント配置機能
   - [ ] 初期化処理の修正

5. **GameWorld修正**
   - [ ] デフォルトエージェントの有効化
   - [ ] 設定による切り替え機能

6. **テスト**
   - [ ] 自己複製プログラムの動作テスト
   - [ ] エージェント生成のテスト
   - [ ] 統合テスト

### 7. テスト計画

#### 7.1 単体テスト
- 自己複製プログラムの各命令の動作確認
- プリセットからのエージェント生成
- ユニット間の接続確認

#### 7.2 統合テスト
- 初期配置されたエージェントの起動確認
- 自己複製動作の確認
- エネルギー収集から分離までの一連の流れ

#### 7.3 パフォーマンステスト
- 複数の自己複製エージェントによる負荷確認
- メモリ使用量の監視

### 8. 将来の拡張

- 複数の異なるプリセット（捕食者、協力型など）
- プリセットの外部ファイル化（JSON形式）
- UIからのプリセット選択機能
- プリセットエディタの実装

### 9. リスクと対策

**リスク1：無制限な自己複製**
- 対策：エネルギー制限、空間制限により自然に制御

**リスク2：初期プログラムのバグ**
- 対策：十分なテスト、デバッグモードの実装

**リスク3：パフォーマンス低下**
- 対策：エージェント数の上限設定、最適化

## まとめ

この実装により、アプリケーション起動時から自己複製の動作を観察できるようになり、Syntheticaの核心的な機能をすぐに体験できるようになる。